@model IEnumerable<ManagingAgriculture.Models.ApplicationUser>
@{
    ViewData["Title"] = "Manage Staff";
}

<div class="container-fluid dashboard-container">
    <div class="row mb-4">
        <div class="col">
            <h2 class="text-primary"><i class="fas fa-users-cog"></i> Manage Staff & HR</h2>
        </div>
        <div class="col-auto">
             <a asp-action="Index" class="btn btn-secondary">Back to Dashboard</a>
        </div>
    </div>
    
    <!-- INVITE SECTION -->
    <div class="card mb-5 shadow-sm">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-envelope-open-text"></i> Send Job Offer / Invite</h5>
        </div>
        <div class="card-body">
            <form asp-action="InviteStaff" method="post">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">Email Address</label>
                        <input type="email" name="email" class="form-control" placeholder="candidate@example.com" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Role</label>
                        <select name="role" class="form-select">
                            <option value="Employee">Employee</option>
                            <option value="Manager">Manager</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Salary Offer ($)</label>
                        <input type="number" name="salary" class="form-control" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Days Off (Yearly)</label>
                        <input type="number" name="leaveDays" class="form-control" value="20" min="0">
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-success w-100 fw-bold">Send Invitation</button>
                    </div>
                </div>
            </form>
            <small class="text-muted mt-2 d-block">
                The candidate will see the Salary and Leave Days offer when they view the invitation.
            </small>
        </div>
    </div>

    <!-- CURRENT STAFF SECTION -->
    <div class="card mb-5 shadow-sm">
        <div class="card-header bg-primary text-white">
             <h5 class="mb-0"><i class="fas fa-user-tie"></i> Current Team</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Employee</th>
                        <th>Role</th>
                        <th>Salary & Paid</th>
                        <th>Leave (Used / Total)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var staff in Model)
                    {
                        <tr>
                            <td>
                                <div class="fw-bold">@staff.Email</div>
                                <small class="text-muted">@staff.UserName</small>
                            </td>
                            <td>
                                @{
                                    var userManager = Context.RequestServices.GetService(typeof(Microsoft.AspNetCore.Identity.UserManager<ManagingAgriculture.Models.ApplicationUser>)) as Microsoft.AspNetCore.Identity.UserManager<ManagingAgriculture.Models.ApplicationUser>;
                                    var roles = await userManager.GetRolesAsync(staff);
                                    var role = roles.FirstOrDefault() ?? "Employee";
                                }
                                <span class="badge @(role=="Manager" ? "bg-warning text-dark" : "bg-info text-dark")">@role</span>
                            </td>
                            
                            <!-- Update Form -->
                            <form asp-action="UpdateEmployeeDetails" method="post">
                                <input type="hidden" name="userId" value="@staff.Id" />
                                <td>
                                    <div class="input-group input-group-sm mb-1" style="width: 150px;">
                                        <span class="input-group-text">$</span>
                                        <input type="number" name="salary" class="form-control" value="@staff.Salary" step="0.01">
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="isSalaryPaid" value="true" @(staff.IsSalaryPaidInfo ? "checked" : "")>
                                        <label class="form-check-label small">Paid?</label>
                                    </div>
                                </td>
                                <td>
                                    <div class="input-group input-group-sm" style="width: 140px;">
                                        <span class="input-group-text">@staff.LeaveDaysUsed /</span>
                                        <input type="number" name="leaveDays" class="form-control" value="@staff.LeaveDaysTotal">
                                    </div>
                                    <button type="button" class="btn btn-sm btn-link p-0 text-decoration-none" onclick="openLeaveCalendar('@staff.Id', '@staff.UserName')">
                                        <i class="far fa-calendar-alt"></i> Manage Leave
                                    </button>
                                </td>
                                <td>
                                    <div class="d-flex flex-column gap-1">
                                        <div class="btn-group btn-group-sm">
                                            <button type="submit" class="btn btn-primary" title="Save Changes"><i class="fas fa-save"></i></button>
                                            <button type="button" class="btn btn-secondary" onclick="openTaskModal('@staff.Id', '@staff.UserName')" title="Manage Tasks">
                                                <i class="fas fa-tasks"></i> Tasks
                                            </button>
                                        </div>
                                        
                                        <div class="btn-group btn-group-sm">
                                            @if (role == "Employee")
                                            {
                                                <button type="submit" formaction="@Url.Action("PromoteStaff")" name="newRole" value="Manager" class="btn btn-outline-warning text-dark">Promote</button>
                                            }
                                            else if (role == "Manager")
                                            {
                                                <!-- Demote Button -->
                                                <button type="submit" formaction="@Url.Action("DemoteStaff")" class="btn btn-outline-secondary">Demote</button>
                                            }
                                            <button type="submit" formaction="@Url.Action("RemoveStaff")" class="btn btn-danger" onclick="return confirm('Are you sure?');"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                </td>
                            </form>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- PENDING INVITES SECTION -->
    <div class="card shadow-sm mb-5">
        <div class="card-header bg-warning text-dark">
             <h5 class="mb-0"><i class="fas fa-clock"></i> Pending Invitations</h5>
        </div>
        <div class="table-responsive">
            <table class="table mb-0">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Role Offer</th>
                        <th>Salary Offer</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var invite in (List<ManagingAgriculture.Models.CompanyInvitation>)ViewBag.Invitations)
                    {
                        <tr>
                            <td>@invite.Email</td>
                            <td>@invite.Role</td>
                            <td>$@invite.Salary</td>
                            <td><span class="badge bg-warning text-dark">Pending Registration</span></td>
                            <td>
                                <form asp-action="CancelInvitation" method="post">
                                    <input type="hidden" name="id" value="@invite.Id" />
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Cancel this invitation"><i class="fas fa-times"></i> Cancel</button>
                                </form>
                            </td>
                        </tr>
                    }
                     @if (!((List<ManagingAgriculture.Models.CompanyInvitation>)ViewBag.Invitations).Any())
                    {
                        <tr><td colspan="5" class="text-center text-muted">No pending invitations.</td></tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- MODALS for Task & Calendar -->
    <!-- Task Modal -->
    <div class="modal fade" id="taskModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Tasks for <span id="taskModalUserName"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Add Task Form -->
                    <form asp-action="AssignTask" method="post" class="mb-4">
                        <input type="hidden" name="userId" id="taskModalUserId" />
                        <div class="input-group">
                            <input type="text" name="description" class="form-control" placeholder="New Task Description..." required>
                            <button class="btn btn-success" type="submit">Assign Task</button>
                        </div>
                    </form>
                    
                    <hr />
                    
                    <!-- Task List -->
                    <h6>Active Tasks</h6>
                    <ul class="list-group" id="taskList">
                        <!-- Loaded via JS -->
                        <li class="list-group-item text-center">Loading...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Modal -->
    <div class="modal fade" id="calendarModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Leave Calendar - <span id="calModalUserName"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Click a date to toggle "Leave" status (Red = Day Off).</p>
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FullCalendar Dependencies -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>

<script>
    // --- TASK MODAL LOGIC ---
    function openTaskModal(userId, userName) {
        document.getElementById('taskModalUserId').value = userId;
        document.getElementById('taskModalUserName').innerText = userName;
        
        var taskList = document.getElementById('taskList');
        taskList.innerHTML = '<li class="list-group-item text-center">Loading...</li>';
        
        // Fetch tasks
        fetch('/Boss/GetEmployeeTasks?userId=' + userId)
            .then(res => res.json())
            .then(data => {
                taskList.innerHTML = '';
                if(data.length === 0) {
                    taskList.innerHTML = '<li class="list-group-item text-center text-muted">No active tasks found</li>';
                    return;
                }
                
                data.forEach(task => {
                    let badge = '';
                    let action = '';
                    
                    if (task.isApprovedByBoss) {
                        badge = '<span class="badge bg-success float-end">Completed</span>';
                    } else if (task.isCompletedByEmployee) {
                        badge = '<span class="badge bg-warning float-end">Waiting Approval</span>';
                        action = `<button class="btn btn-sm btn-outline-success mt-2" onclick="approveTask(${task.id})">Approve</button>`;
                    } else {
                        badge = '<span class="badge bg-secondary float-end">In Progress</span>';
                    }
                    
                    let item = `
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>${task.description}</strong>
                                    <br><small class="text-muted">Assigned: ${task.assignedDate}</small>
                                </div>
                                <div>${badge}</div>
                            </div>
                            ${action}
                        </li>
                    `;
                    taskList.innerHTML += item;
                });
            });
            
        var myModal = new bootstrap.Modal(document.getElementById('taskModal'));
        myModal.show();
    }
    
    function approveTask(taskId) {
        fetch('/Boss/ApproveTask?taskId=' + taskId, { method: 'POST' })
            .then(res => {
                if(res.ok) {
                    // Refresh
                    openTaskModal(document.getElementById('taskModalUserId').value, document.getElementById('taskModalUserName').innerText);
                }
            });
    }


    // --- CALENDAR LOGIC ---
    var calendar = null;
    
    function openLeaveCalendar(userId, userName) {
        document.getElementById('calModalUserName').innerText = userName;
        var myModal = new bootstrap.Modal(document.getElementById('calendarModal'));
        myModal.show();
        
        // Init calendar after modal shows (timeout to ensure rendering)
        setTimeout(() => {
            var calendarEl = document.getElementById('calendar');
            if(calendar) calendar.destroy();
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                height: 500,
                events: '/Boss/GetLeaveDates?userId=' + userId,
                dateClick: function(info) {
                    // Toggle Leave
                    fetch(`/Boss/ToggleLeaveDate?userId=${userId}&date=${info.dateStr}`, { method: 'POST' })
                        .then(res => res.json())
                        .then(d => {
                             calendar.refetchEvents(); // Refresh events
                        });
                }
            });
            calendar.render();
        }, 300);
    }
</script>

